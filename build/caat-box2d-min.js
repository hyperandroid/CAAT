/*! CAAT 2013-03-05 */
CAAT.Module({defines:"CAAT.Foundation.Box2D.B2DBodyActor",depends:["CAAT.Foundation.Actor"],aliases:["CAAT.B2DBodyActor"],extendsClass:"CAAT.Foundation.Actor",extendsWith:function(){return CAAT.PMR=64,CAAT.enableBox2DDebug=function(t,e,i,n){if(t){var s=new Box2D.Dynamics.b2DebugDraw;try{s.m_sprite.graphics.clear=function(){}}catch(r){}i.SetDebugDraw(s),s.SetSprite(e.ctx),s.SetDrawScale(n||CAAT.PMR),s.SetFillAlpha(.5),s.SetLineThickness(1),s.SetFlags(3)}else i.SetDebugDraw(null)},{restitution:.5,friction:.5,density:1,bodyType:Box2D.Dynamics.b2Body.b2_dynamicBody,worldBody:null,world:null,worldBodyFixture:null,bodyDef:null,fixtureDef:null,bodyData:null,recycle:!1,__init:function(){return this.__super(),this.setPositionAnchor(.5,.5),this},setPositionAnchor:function(){this.tAnchorX=.5,this.tAnchorY=.5},setPositionAnchored:function(t,e){this.x=t,this.y=e,this.tAnchorX=.5,this.tAnchorY=.5},setRecycle:function(){return this.recycle=!0,this},destroy:function(){if(CAAT.Foundation.Box2D.B2DBodyActor.superclass.destroy.call(this),this.recycle)this.setLocation(-Number.MAX_VALUE,-Number.MAX_VALUE),this.setAwake(!1);else{var t=this.worldBody;t.DestroyFixture(this.worldBodyFixture),this.world.DestroyBody(t)}return this},setAwake:function(t){return this.worldBody.SetAwake(t),this},setSleepingAllowed:function(t){return this.worldBody.SetSleepingAllowed(t),this},setLocation:function(t,e){return this.worldBody.SetPosition(new Box2D.Common.Math.b2Vec2(t/CAAT.PMR,e/CAAT.PMR)),this},setDensity:function(t){return this.density=t,this},setFriction:function(t){return this.friction=t,this},setRestitution:function(t){return this.restitution=t,this},setBodyType:function(t){return this.bodyType=t,this},check:function(t,e,i){t[e]||(t[e]=i)},createBody:function(t,e){return e&&(this.check(e,"density",1),this.check(e,"friction",.5),this.check(e,"restitution",.2),this.check(e,"bodyType",Box2D.Dynamics.b2Body.b2_staticBody),this.check(e,"userData",{}),this.check(e,"image",null),this.density=e.density,this.friction=e.friction,this.restitution=e.restitution,this.bodyType=e.bodyType,this.image=e.image),this.world=t,this},getCenter:function(){return this.worldBody.GetPosition()},getDistanceJointLocalAnchor:function(){return new Box2D.Common.Math.b2Vec2(0,0)},animate:function(t,e){var i=this.worldBody.GetPosition();return CAAT.Foundation.Actor.prototype.setLocation.call(this,CAAT.PMR*i.x,CAAT.PMR*i.y),this.setRotation(this.worldBody.GetAngle()),CAAT.Foundation.Box2D.B2DBodyActor.superclass.animate.call(this,t,e)}}}}),CAAT.Module({defines:"CAAT.Foundation.Box2D.B2DCircularBody",depends:["CAAT.Foundation.Box2D.B2DBodyActor"],aliases:["CAAT.B2DCircularBody"],extendsClass:"CAAT.Foundation.Box2D.B2DBodyActor",constants:{createCircularBody:function(t,e){e.radius&&(this.radius=e.radius);var i=new Box2D.Dynamics.b2FixtureDef;i.density=e.density,i.friction=e.friction,i.restitution=e.restitution,i.shape=new Box2D.Collision.Shapes.b2CircleShape(e.radius/CAAT.PMR);var n=new Box2D.Dynamics.b2BodyDef;n.type=e.bodyType,n.position.Set(e.x/CAAT.PMR,e.y/CAAT.PMR),i.userData=e.userData,n.userData=e.userData;var s=t.CreateBody(n),r=s.CreateFixture(i);return e.isSensor&&r.SetSensor(!0),{worldBody:s,worldBodyFixture:r,fixDef:i,bodyDef:n}}},extendsWith:{radius:1,createBody:function(t,e){var i=e.radius||1;i+=(e.bodyDefScaleTolerance||0)*Math.random(),e.radius=i,CAAT.Foundation.Box2D.B2DCircularBody.superclass.createBody.call(this,t,e);var n=CAAT.Foundation.Box2D.B2DCircularBody.createCircularBody(t,e);return e.userData.actor=this,this.worldBody=n.worldBody,this.worldBodyFixture=n.worldBodyFixture,this.fixtureDef=n.fixDef,this.bodyDef=n.bodyDef,this.bodyData=e,this.setFillStyle(this.worldBodyFixture.IsSensor()?"red":"green").setBackgroundImage(this.image).setSize(2*e.radius,2*e.radius).setImageTransformation(CAAT.Foundation.SpriteImage.TR_FIXED_TO_SIZE),this}}}),CAAT.Module({defines:"CAAT.Foundation.Box2D.B2DPolygonBody",depends:["CAAT.Foundation.Box2D.B2DBodyActor","CAAT.Foundation.SpriteImage"],aliases:["CAAT.B2DPolygonBody"],constants:{TYPE:{EDGE:"edge",BOX:"box",POLYGON:"polygon"},createPolygonBody:function(t,e){var i=new Box2D.Dynamics.b2FixtureDef;i.density=e.density,i.friction=e.friction,i.restitution=e.restitution,i.shape=new Box2D.Collision.Shapes.b2PolygonShape;var n=Number.MAX_VALUE,s=-Number.MAX_VALUE,r=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=[],h=e.bodyDefScale||1;h+=(e.bodyDefScaleTolerance||0)*Math.random();for(var l=0;e.bodyDef.length>l;l++){var u=e.bodyDef[l].x*h,c=e.bodyDef[l].y*h;n>u&&(n=u),u>s&&(s=u),r>c&&(r=c),c>a&&(a=c),o.push(new Box2D.Common.Math.b2Vec2(u/CAAT.PMR,c/CAAT.PMR))}var d=[{x:n,y:r},{x:s,y:a}],A=new Box2D.Dynamics.b2BodyDef;if(A.type=e.bodyType,A.position.Set(((s-n)/2+(e.x||0))/CAAT.PMR,((a-r)/2+(e.y||0))/CAAT.PMR),e.polygonType===CAAT.Foundation.Box2D.B2DPolygonBody.TYPE.EDGE){var f=new Box2D.Common.Math.b2Vec2(o[0].x,o[0].y),g=new Box2D.Common.Math.b2Vec2(o[1].x-o[0].x,o[1].y-o[0].y);A.position.Set(f.x,f.y),i.shape.SetAsEdge(new Box2D.Common.Math.b2Vec2(0,0),g)}else if(e.polygonType===CAAT.Foundation.Box2D.B2DPolygonBody.TYPE.BOX)i.shape.SetAsBox((s-n)/2/CAAT.PMR,(a-r)/2/CAAT.PMR);else{if(e.polygonType!==CAAT.Foundation.Box2D.B2DPolygonBody.TYPE.POLYGON)throw"Unkown bodyData polygonType: "+e.polygonType;i.shape.SetAsArray(o,o.length)}i.userData=e.userData,A.userData=e.userData;var p=t.CreateBody(A),m=p.CreateFixture(i);return e.isSensor&&m.SetSensor(!0),{worldBody:p,worldBodyFixture:m,fixDef:i,bodyDef:A,boundingBox:d}}},extendsClass:"CAAT.Foundation.Box2D.B2DBodyActor",extendsWith:{boundingBox:null,getDistanceJointLocalAnchor:function(){var t=this.worldBody,e=t.GetFixtureList().GetShape().GetLocalCenter();return e},createBody:function(t,e){CAAT.Foundation.Box2D.B2DPolygonBody.superclass.createBody.call(this,t,e);var i=CAAT.Foundation.Box2D.B2DPolygonBody.createPolygonBody(t,e);return e.userData.actor=this,this.worldBody=i.worldBody,this.worldBodyFixture=i.worldBodyFixture,this.fixtureDef=i.fixDef,this.bodyDef=i.bodyDef,this.bodyData=e,this.boundingBox=i.boundingBox,this.setBackgroundImage(e.image).setSize(i.boundingBox[1].x-i.boundingBox[0].x+1,i.boundingBox[1].y-i.boundingBox[0].y+1).setFillStyle(i.worldBodyFixture.IsSensor()?"#0f0":"#f00").setImageTransformation(CAAT.Foundation.SpriteImage.TR_FIXED_TO_SIZE),this}}}),CAAT.ModuleManager.solveAll();